openapi: 3.0.3
info:
  title: RAG Q&A System API
  description: |
    RESTful API for the RAG-based Question Answering System.

    This API provides endpoints for:
    - Document ingestion (admin)
    - Query submission (users)
    - Query status and results retrieval
    - System health monitoring

    **Authentication**: API key required for all admin endpoints (X-API-Key header).
    Query endpoints can be optionally authenticated based on deployment configuration.

    **Rate Limits**:
    - Admin endpoints: 10 requests/hour per API key
    - Query endpoints: 100 requests/hour per user/IP

    **Base URL**: `https://api.example.com/v1`
  version: 1.0.0
  contact:
    name: RAG Q&A System Support
    email: support@example.com

servers:
  - url: https://api.example.com/v1
    description: Production server
  - url: https://staging.api.example.com/v1
    description: Staging server
  - url: http://localhost:8000/v1
    description: Local development server

security:
  - ApiKeyAuth: []
  - {}  # Some endpoints are public

tags:
  - name: Query
    description: User query submission and retrieval
  - name: Ingestion
    description: Document ingestion (admin only)
  - name: Monitoring
    description: System health and metrics
  - name: Escalation
    description: Human support escalation queue (admin only)

paths:
  /query:
    post:
      tags:
        - Query
      summary: Submit a question
      description: |
        Submit a natural language question to the RAG system.
        The system will retrieve relevant context from the knowledge base and generate an answer.

        **Latency**: Typically 2-5 seconds for p95 latency.
        **Cost**: Queries are rate-limited to prevent abuse.
      operationId: submitQuery
      security:
        - {}  # Public endpoint (optional authentication)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/QueryRequest'
            examples:
              simple_query:
                summary: Simple factual question
                value:
                  query_text: "Quais são os principais motivos de avaliações negativas?"
                  user_id: "user_12345"
                  session_id: "sess_abc123"
              complex_query:
                summary: Multi-aspect question
                value:
                  query_text: "Compare a satisfação com entrega entre eletrônicos e móveis"
                  user_id: "user_67890"
                  options:
                    collection_filter: ["olist_reviews"]
                    max_chunks: 15
      responses:
        '200':
          description: Query processed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/QueryResponse'
              examples:
                success_high_confidence:
                  summary: Successful answer with high confidence
                  value:
                    query_id: "770e8400-e29b-41d4-a716-446655440002"
                    answer_text: "Com base nas avaliações, os principais motivos de reclamações negativas são: 1) Atraso na entrega (45%), 2) Produto com defeito (30%), 3) Atendimento ao cliente ruim (15%), 4) Embalagem danificada (10%)."
                    confidence_score: 0.85
                    status: "completed"
                    escalation_suggested: false
                    sources:
                      - chunk_id: "660e8400-e29b-41d4-a716-446655440001"
                        relevance_score: 0.87
                        text_preview: "O produto chegou com defeito..."
                    latency_ms: 620
                success_low_confidence:
                  summary: Answer with low confidence (escalation suggested)
                  value:
                    query_id: "880e8400-e29b-41d4-a716-446655440008"
                    answer_text: "Não tenho informações suficientes para responder com certeza. Parece que você está perguntando sobre..."
                    confidence_score: 0.62
                    status: "completed"
                    escalation_suggested: true
                    escalation_message: "Esta resposta pode não estar completa. Deseja falar com um especialista?"
                    sources: []
                    latency_ms: 1200
        '400':
          description: Invalid request (query too long, malformed, etc.)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error_code: "INVALID_QUERY"
                message: "Query text exceeds maximum length of 1000 characters"
                details:
                  query_length: 1523
                  max_length: 1000
        '429':
          description: Rate limit exceeded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error_code: "RATE_LIMIT_EXCEEDED"
                message: "You have exceeded the rate limit of 100 queries per hour"
                details:
                  limit: 100
                  window_seconds: 3600
                  retry_after_seconds: 1200
        '503':
          description: Service temporarily unavailable
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error_code: "SERVICE_UNAVAILABLE"
                message: "Vector database is temporarily unavailable. Please try again in a few seconds."
                details:
                  component: "qdrant"
                  estimated_recovery_seconds: 30

  /query/{query_id}:
    get:
      tags:
        - Query
      summary: Get query status and results
      description: Retrieve the status and results of a previously submitted query.
      operationId: getQuery
      security:
        - {}
      parameters:
        - name: query_id
          in: path
          required: true
          description: UUID of the query
          schema:
            type: string
            format: uuid
          example: "770e8400-e29b-41d4-a716-446655440002"
      responses:
        '200':
          description: Query found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/QueryResponse'
        '404':
          description: Query not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error_code: "QUERY_NOT_FOUND"
                message: "No query found with ID 770e8400-e29b-41d4-a716-446655440002"

  /query/{query_id}/escalate:
    post:
      tags:
        - Query
        - Escalation
      summary: Manually escalate query to human support
      description: User explicitly requests human assistance for a query.
      operationId: escalateQuery
      security:
        - {}
      parameters:
        - name: query_id
          in: path
          required: true
          description: UUID of the query to escalate
          schema:
            type: string
            format: uuid
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                reason:
                  type: string
                  description: Optional user-provided reason for escalation
                  maxLength: 500
                  example: "A resposta não está clara, preciso de mais detalhes"
      responses:
        '200':
          description: Query escalated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  escalation_id:
                    type: string
                    format: uuid
                    description: ID of the escalation request
                  message:
                    type: string
                    example: "Sua solicitação foi encaminhada para nossa equipe de suporte. Tempo estimado de resposta: 2 horas"
                  estimated_wait_minutes:
                    type: integer
                    example: 120
        '404':
          description: Query not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /documents:
    post:
      tags:
        - Ingestion
      summary: Ingest a new document
      description: |
        Upload a document for ingestion into the knowledge base (admin only).

        **Supported formats**: CSV, PDF, DOCX, TXT, MD
        **Max file size**: 2GB
        **Processing time**: Approximately 10 minutes per 100MB

        The document will be asynchronously processed (extraction, chunking, embedding, indexing).
        Use the returned `document_id` to poll `/documents/{document_id}` for status.
      operationId: ingestDocument
      security:
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - file
                - collection_name
              properties:
                file:
                  type: string
                  format: binary
                  description: Document file to upload
                collection_name:
                  type: string
                  description: Target collection for vectors
                  example: "olist_reviews"
                metadata:
                  type: object
                  description: Optional custom metadata (JSON)
                  example:
                    source: "kaggle"
                    dataset_version: "1.0"
                    uploader_id: "admin"
      responses:
        '202':
          description: Document accepted for processing
          content:
            application/json:
              schema:
                type: object
                properties:
                  document_id:
                    type: string
                    format: uuid
                    example: "550e8400-e29b-41d4-a716-446655440000"
                  file_name:
                    type: string
                    example: "olist_order_reviews_dataset.csv"
                  status:
                    type: string
                    enum: [pending, processing]
                    example: "pending"
                  message:
                    type: string
                    example: "Document queued for processing. Check status at /documents/550e8400-e29b-41d4-a716-446655440000"
                  estimated_processing_minutes:
                    type: integer
                    example: 10
        '400':
          description: Invalid request (unsupported format, file too large, etc.)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error_code: "INVALID_FILE_FORMAT"
                message: "Unsupported file format: .exe. Supported formats: CSV, PDF, DOCX, TXT, MD"
        '401':
          description: Unauthorized (missing or invalid API key)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error_code: "UNAUTHORIZED"
                message: "Missing or invalid API key. Provide X-API-Key header."
        '413':
          description: File too large
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error_code: "FILE_TOO_LARGE"
                message: "File size exceeds maximum of 2GB"
                details:
                  file_size_bytes: 2200000000
                  max_size_bytes: 2147483648

  /documents/{document_id}:
    get:
      tags:
        - Ingestion
      summary: Get document ingestion status
      description: Check the processing status of an uploaded document.
      operationId: getDocument
      security:
        - ApiKeyAuth: []
      parameters:
        - name: document_id
          in: path
          required: true
          description: UUID of the document
          schema:
            type: string
            format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
      responses:
        '200':
          description: Document found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DocumentStatus'
              examples:
                completed:
                  summary: Document processing completed
                  value:
                    document_id: "550e8400-e29b-41d4-a716-446655440000"
                    file_name: "olist_order_reviews_dataset.csv"
                    status: "completed"
                    chunk_count: 12543
                    upload_timestamp: "2025-11-13T10:30:00Z"
                    completed_timestamp: "2025-11-13T10:37:42Z"
                    processing_duration_seconds: 462
                processing:
                  summary: Document currently processing
                  value:
                    document_id: "550e8400-e29b-41d4-a716-446655440000"
                    file_name: "olist_order_reviews_dataset.csv"
                    status: "processing"
                    current_stage: "embedding"
                    progress_percentage: 65
                    chunks_processed: 8153
                    chunks_total: 12543
                    upload_timestamp: "2025-11-13T10:30:00Z"
                    estimated_completion_timestamp: "2025-11-13T10:38:00Z"
                failed:
                  summary: Document processing failed
                  value:
                    document_id: "550e8400-e29b-41d4-a716-446655440000"
                    file_name: "corrupted_file.csv"
                    status: "failed"
                    error_message: "Invalid CSV format: missing 'review_text' column"
                    upload_timestamp: "2025-11-13T10:30:00Z"
                    failed_timestamp: "2025-11-13T10:30:15Z"
        '404':
          description: Document not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /escalations:
    get:
      tags:
        - Escalation
      summary: List escalation requests (admin only)
      description: Retrieve the queue of escalated queries awaiting human review.
      operationId: listEscalations
      security:
        - ApiKeyAuth: []
      parameters:
        - name: status
          in: query
          description: Filter by assignment status
          schema:
            type: string
            enum: [queued, assigned, resolved]
            default: queued
        - name: limit
          in: query
          description: Maximum number of results
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
        - name: offset
          in: query
          description: Pagination offset
          schema:
            type: integer
            minimum: 0
            default: 0
      responses:
        '200':
          description: List of escalation requests
          content:
            application/json:
              schema:
                type: object
                properties:
                  escalations:
                    type: array
                    items:
                      $ref: '#/components/schemas/EscalationRequest'
                  total_count:
                    type: integer
                    example: 45
                  has_more:
                    type: boolean
                    example: true
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /escalations/{escalation_id}/assign:
    post:
      tags:
        - Escalation
      summary: Assign escalation to agent (admin only)
      description: Claim an escalation request for review.
      operationId: assignEscalation
      security:
        - ApiKeyAuth: []
      parameters:
        - name: escalation_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - agent_id
              properties:
                agent_id:
                  type: string
                  example: "agent_jane_doe"
      responses:
        '200':
          description: Escalation assigned successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  escalation_id:
                    type: string
                    format: uuid
                  assigned_agent_id:
                    type: string
                  assignment_timestamp:
                    type: string
                    format: date-time
        '404':
          description: Escalation not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '409':
          description: Escalation already assigned
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error_code: "ALREADY_ASSIGNED"
                message: "Escalation is already assigned to agent_john_smith"

  /escalations/{escalation_id}/resolve:
    post:
      tags:
        - Escalation
      summary: Resolve escalation (admin only)
      description: Mark an escalation as resolved with optional feedback.
      operationId: resolveEscalation
      security:
        - ApiKeyAuth: []
      parameters:
        - name: escalation_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                agent_feedback:
                  type: string
                  description: Agent's notes or correct answer
                  maxLength: 5000
                  example: "Respondi diretamente ao cliente com informações detalhadas sobre políticas de devolução."
      responses:
        '200':
          description: Escalation resolved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  escalation_id:
                    type: string
                    format: uuid
                  resolution_timestamp:
                    type: string
                    format: date-time
        '404':
          description: Escalation not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /health:
    get:
      tags:
        - Monitoring
      summary: Health check
      description: Check if the API is alive and operational.
      operationId: healthCheck
      security:
        - {}
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    enum: [healthy, degraded, unhealthy]
                    example: "healthy"
                  timestamp:
                    type: string
                    format: date-time
                  components:
                    type: object
                    properties:
                      database:
                        type: string
                        enum: [up, down]
                        example: "up"
                      vector_db:
                        type: string
                        enum: [up, down]
                        example: "up"
                      message_queue:
                        type: string
                        enum: [up, down]
                        example: "up"
                      llm_api:
                        type: string
                        enum: [up, down]
                        example: "up"
        '503':
          description: Service is unhealthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "unhealthy"
                  timestamp:
                    type: string
                    format: date-time
                  components:
                    type: object
                    properties:
                      vector_db:
                        type: string
                        example: "down"
                  message:
                    type: string
                    example: "Vector database is unavailable"

  /metrics:
    get:
      tags:
        - Monitoring
      summary: Get system metrics (admin only)
      description: Retrieve aggregated system performance metrics.
      operationId: getMetrics
      security:
        - ApiKeyAuth: []
      parameters:
        - name: window
          in: query
          description: Time window for aggregation
          schema:
            type: string
            enum: [1h, 6h, 24h, 7d]
            default: 1h
      responses:
        '200':
          description: System metrics
          content:
            application/json:
              schema:
                type: object
                properties:
                  window:
                    type: string
                    example: "1h"
                  query_metrics:
                    type: object
                    properties:
                      total_queries:
                        type: integer
                        example: 1543
                      queries_per_second_avg:
                        type: number
                        format: float
                        example: 0.43
                      latency_p50_ms:
                        type: integer
                        example: 620
                      latency_p95_ms:
                        type: integer
                        example: 1850
                      latency_p99_ms:
                        type: integer
                        example: 3200
                      error_rate_percentage:
                        type: number
                        format: float
                        example: 0.8
                      cache_hit_rate_percentage:
                        type: number
                        format: float
                        example: 32.5
                  quality_metrics:
                    type: object
                    properties:
                      avg_confidence_score:
                        type: number
                        format: float
                        example: 0.82
                      escalation_rate_percentage:
                        type: number
                        format: float
                        example: 12.3
                  cost_metrics:
                    type: object
                    properties:
                      llm_api_cost_usd:
                        type: number
                        format: float
                        example: 15.75
                      embedding_api_cost_usd:
                        type: number
                        format: float
                        example: 1.20
                      total_cost_usd:
                        type: number
                        format: float
                        example: 16.95

components:
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key
      description: API key for admin operations

  schemas:
    QueryRequest:
      type: object
      required:
        - query_text
      properties:
        query_text:
          type: string
          description: Natural language question
          minLength: 1
          maxLength: 1000
          example: "Quais são os principais motivos de avaliações negativas?"
        user_id:
          type: string
          description: Optional user identifier
          maxLength: 100
          example: "user_12345"
        session_id:
          type: string
          description: Optional session ID for multi-turn conversations
          maxLength: 100
          example: "sess_abc123"
        options:
          type: object
          description: Optional query options
          properties:
            collection_filter:
              type: array
              items:
                type: string
              description: Restrict search to specific collections
              example: ["olist_reviews"]
            max_chunks:
              type: integer
              description: Maximum chunks to retrieve
              minimum: 1
              maximum: 20
              default: 10
            enable_reranking:
              type: boolean
              description: Enable cross-encoder reranking (higher quality, slower)
              default: false

    QueryResponse:
      type: object
      properties:
        query_id:
          type: string
          format: uuid
          description: Unique query identifier
          example: "770e8400-e29b-41d4-a716-446655440002"
        answer_text:
          type: string
          description: Generated answer
          example: "Com base nas avaliações, os principais motivos..."
        confidence_score:
          type: number
          format: float
          description: Answer confidence (0-1)
          minimum: 0
          maximum: 1
          example: 0.85
        status:
          type: string
          enum: [pending, processing, completed, failed, escalated]
          example: "completed"
        escalation_suggested:
          type: boolean
          description: Whether human escalation is suggested
          example: false
        escalation_message:
          type: string
          description: Message to user if escalation is suggested
          example: "Esta resposta pode não estar completa. Deseja falar com um especialista?"
        sources:
          type: array
          description: Retrieved source chunks
          items:
            type: object
            properties:
              chunk_id:
                type: string
                format: uuid
              relevance_score:
                type: number
                format: float
              text_preview:
                type: string
                description: First 200 chars of chunk
        latency_ms:
          type: integer
          description: Total processing time in milliseconds
          example: 620

    DocumentStatus:
      type: object
      properties:
        document_id:
          type: string
          format: uuid
        file_name:
          type: string
        status:
          type: string
          enum: [pending, processing, completed, failed]
        chunk_count:
          type: integer
          description: Number of chunks created (null if processing)
        upload_timestamp:
          type: string
          format: date-time
        completed_timestamp:
          type: string
          format: date-time
          description: When processing completed (null if not done)
        processing_duration_seconds:
          type: integer
        current_stage:
          type: string
          enum: [preprocessing, chunking, embedding, indexing]
          description: Current processing stage (if status=processing)
        progress_percentage:
          type: integer
          minimum: 0
          maximum: 100
          description: Processing progress (if status=processing)
        chunks_processed:
          type: integer
        chunks_total:
          type: integer
        error_message:
          type: string
          description: Error details (if status=failed)

    EscalationRequest:
      type: object
      properties:
        escalation_id:
          type: string
          format: uuid
        query_id:
          type: string
          format: uuid
        query_text:
          type: string
          description: Original user question
        answer_text:
          type: string
          description: System's attempted answer (if any)
        confidence_score:
          type: number
          format: float
        escalation_reason:
          type: string
          enum: [low_confidence, validation_failure, user_request]
        escalation_timestamp:
          type: string
          format: date-time
        priority_score:
          type: number
          format: float
          description: Calculated priority (0-1, higher=more urgent)
        assignment_status:
          type: string
          enum: [queued, assigned, resolved]
        assigned_agent_id:
          type: string
        sources:
          type: array
          description: Retrieved chunks for context
          items:
            type: object
            properties:
              chunk_id:
                type: string
                format: uuid
              text_content:
                type: string

    ErrorResponse:
      type: object
      required:
        - error_code
        - message
      properties:
        error_code:
          type: string
          description: Machine-readable error code
          example: "INVALID_QUERY"
        message:
          type: string
          description: Human-readable error message
          example: "Query text exceeds maximum length of 1000 characters"
        details:
          type: object
          description: Additional error context (varies by error type)
